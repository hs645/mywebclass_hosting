# Production Infrastructure Stack
# Caddy (reverse proxy + SSL) + PostgreSQL + pgAdmin + Watchtower

services:
  # Caddy - Reverse Proxy with Automatic HTTPS
  caddy:
    image: caddy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"       # HTTP (redirects to HTTPS)
      - "443:443"     # HTTPS
      - "443:443/udp" # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    networks:
      - web
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:2019/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # PostgreSQL - Production Database
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dbadmin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: ${POSTGRES_DB:-production}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    # Security: Do NOT expose port 5432 to host
    # Projects connect via internal network only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dbadmin} -d ${POSTGRES_DB:-production} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # pgAdmin - Database Management UI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:?Please set PGADMIN_EMAIL in .env}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?Please set PGADMIN_PASSWORD in .env}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - web
      - internal
    depends_on:
      - postgres
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower - Automated Container Updates (OPTIONAL)
  # Uncomment if your Docker API version is compatible (1.44+)
  # Check with: docker version
  # watchtower:
  #   image: containrrr/watchtower:latest
  #   container_name: watchtower
  #   restart: unless-stopped
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   environment:
  #     - WATCHTOWER_CLEANUP=true
  #     - WATCHTOWER_LABEL_ENABLE=true
  #     - WATCHTOWER_INCLUDE_RESTARTING=true
  #     - WATCHTOWER_SCHEDULE=0 0 4 * * *
  #   networks:
  #     - web
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=true"

# Networks
networks:
  web:
    name: web
    driver: bridge
  internal:
    name: internal
    driver: bridge
    internal: true

# Volumes for persistent data
volumes:
  caddy_data:
    name: caddy_data
  caddy_config:
    name: caddy_config
  caddy_logs:
    name: caddy_logs
  postgres_data:
    name: postgres_data
  pgadmin_data:
    name: pgadmin_data
